#!/bin/bash
# PHP Version Manager (PHPVM) v1.0.0
# https://github.com/professor93/phpvm
# This file is auto-generated. Do not edit directly.

set -o pipefail

# === config.sh ===

PHPVM_VERSION="1.0.0"
PHPVM_REPO="professor93/phpvm"
PHPVM_GITHUB_API="https://api.github.com/repos/${PHPVM_REPO}/releases/latest"
PHPVM_RAW_URL="https://raw.githubusercontent.com/${PHPVM_REPO}/main"

GUM_GITHUB_REPO="charmbracelet/gum"
GUM_MIN_VERSION="0.13.0"

PHPVM_BIN_DIR="/usr/local/bin"
PHPVM_ENV_FILE="/etc/profile.d/phpvm.sh"
PHPVM_BIN_DIR_USER="$HOME/.local/bin"
PHPVM_ENV_FILE_USER="$HOME/.config/phpvm/env.sh"

PHPVM_DIR="$HOME/.phpversion"
PHPVM_CONFIG="$PHPVM_DIR/config"
SYSTEM_CONFIG="/etc/phpversion"

SUPPORTED_VERSIONS=("8.5" "8.4" "8.3" "8.2" "8.1" "8.0" "7.4" "7.3" "7.2" "7.1" "7.0" "5.6")

DEFAULT_EXTENSIONS=(
    "cli" "common" "curl" "mbstring" "xml" "zip" "bcmath"
    "ctype" "dom" "fileinfo" "pdo" "tokenizer" "filter" "session"
)

LOG_TIMESTAMPS=true  # Enable timestamps in verbose/log output
LOG_FILE="$HOME/.phpversion/phpvm.log"

# === colors.sh ===

setup_colors() {
    if [[ -t 1 ]]; then
        RED=$(tput setaf 1 2>/dev/null || echo '')
        GREEN=$(tput setaf 2 2>/dev/null || echo '')
        YELLOW=$(tput setaf 3 2>/dev/null || echo '')
        BLUE=$(tput setaf 4 2>/dev/null || echo '')
        CYAN=$(tput setaf 6 2>/dev/null || echo '')
        MAGENTA=$(tput setaf 5 2>/dev/null || echo '')
        BOLD=$(tput bold 2>/dev/null || echo '')
        DIM=$(tput dim 2>/dev/null || echo '')
        RESET=$(tput sgr0 2>/dev/null || echo '')
    else
        RED="" GREEN="" YELLOW="" BLUE="" CYAN="" MAGENTA="" BOLD="" DIM="" RESET=""
    fi
}

# === utils.sh ===

timestamp() {
    date "+%Y-%m-%d %H:%M:%S"
}

msg() {
    echo "${GREEN}→${RESET} $*"
}

warn() {
    echo "${YELLOW}⚠${RESET} $*"
}

error() {
    echo "${RED}✗${RESET} $*" >&2
}

success() {
    echo "${GREEN}✓${RESET} $*"
}

log() {
    local level="$1"
    shift
    if [[ "$LOG_TIMESTAMPS" == "true" ]]; then
        echo "[$(timestamp)] [$level] $*" >> "$LOG_FILE" 2>/dev/null
    fi
}

info_log() {
    local msg="$*"
    if [[ "$LOG_TIMESTAMPS" == "true" ]]; then
        echo "${DIM}[$(timestamp)]${RESET} ${CYAN}ℹ${RESET} $msg"
    else
        echo "${CYAN}ℹ${RESET} $msg"
    fi
    log "INFO" "$msg"
}

run_privileged() {
    if [[ $EUID -eq 0 ]]; then
        "$@"
    else
        sudo "$@"
    fi
}

check_sudo() {
    if [[ $EUID -ne 0 ]]; then
        if ! sudo -v &>/dev/null; then
            error "This operation requires sudo privileges"
            exit 1
        fi
    fi
}

init_phpvm() {
    mkdir -p "$PHPVM_DIR"
    touch "$LOG_FILE" 2>/dev/null || true
}

command_exists() {
    command -v "$1" &>/dev/null
}

version_gte() {
    printf '%s\n%s\n' "$2" "$1" | sort -V -C
}

validate_version_format() {
    local version="$1"
    if [[ ! "$version" =~ ^[0-9]+\.[0-9]+$ ]]; then
        error "Invalid version format: $version"
        echo "Version must be in format X.Y (e.g., 8.4)"
        return 1
    fi
}

is_supported_version() {
    local version="$1"
    for v in "${SUPPORTED_VERSIONS[@]}"; do
        [[ "$v" == "$version" ]] && return 0
    done
    return 1
}

# === platform.sh ===

detect_distro() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        DISTRO_ID="${ID:-unknown}"
        DISTRO_ID_LIKE="${ID_LIKE:-}"
        DISTRO_VERSION="${VERSION_ID:-}"
        DISTRO_NAME="${PRETTY_NAME:-$ID}"
    elif [[ -f /etc/redhat-release ]]; then
        DISTRO_ID="rhel"
        DISTRO_NAME=$(cat /etc/redhat-release)
    elif [[ -f /etc/debian_version ]]; then
        DISTRO_ID="debian"
        DISTRO_NAME="Debian $(cat /etc/debian_version)"
    else
        DISTRO_ID="unknown"
        DISTRO_NAME="Unknown Linux"
    fi

    # Detect WSL
    IS_WSL=false
    if grep -qi microsoft /proc/version 2>/dev/null; then
        IS_WSL=true
    fi
}

get_package_manager() {
    case "$DISTRO_ID" in
        ubuntu|debian|linuxmint|pop)
            echo "apt"
            ;;
        fedora|rhel|centos|rocky|alma|ol)
            if command_exists dnf; then
                echo "dnf"
            else
                echo "yum"
            fi
            ;;
        opensuse*|sles)
            echo "zypper"
            ;;
        arch|manjaro)
            echo "pacman"
            ;;
        *)
            # Check by ID_LIKE
            if [[ "$DISTRO_ID_LIKE" == *"debian"* ]] || [[ "$DISTRO_ID_LIKE" == *"ubuntu"* ]]; then
                echo "apt"
            elif [[ "$DISTRO_ID_LIKE" == *"rhel"* ]] || [[ "$DISTRO_ID_LIKE" == *"fedora"* ]]; then
                command_exists dnf && echo "dnf" || echo "yum"
            else
                echo "unknown"
            fi
            ;;
    esac
}

get_php_package_prefix() {
    local pm=$(get_package_manager)
    case "$pm" in
        apt)
            echo "php"  # php8.4, php8.4-cli, etc.
            ;;
        dnf|yum)
            echo "php"  # php84, php84-cli, etc. (Remi format)
            ;;
        *)
            echo "php"
            ;;
    esac
}

get_php_binary_path() {
    local version="$1"
    local pm=$(get_package_manager)

    case "$pm" in
        apt)
            echo "/usr/bin/php${version}"
            ;;
        dnf|yum)
            # Remi installs as php (managed by alternatives) or /usr/bin/phpXY
            local v_nodot="${version//./}"
            if [[ -x "/usr/bin/php${v_nodot}" ]]; then
                echo "/usr/bin/php${v_nodot}"
            elif [[ -x "/opt/remi/php${v_nodot}/root/usr/bin/php" ]]; then
                echo "/opt/remi/php${v_nodot}/root/usr/bin/php"
            else
                echo "/usr/bin/php${version}"
            fi
            ;;
        *)
            echo "/usr/bin/php${version}"
            ;;
    esac
}

check_php_repository() {
    local pm=$(get_package_manager)

    case "$pm" in
        apt)
            # Check for Ondrej's PPA
            if ls /etc/apt/sources.list.d/*ondrej* &>/dev/null || \
               grep -r "ondrej/php" /etc/apt/sources.list.d/ &>/dev/null; then
                return 0
            fi
            return 1
            ;;
        dnf|yum)
            # Check for Remi repository
            if [[ -f /etc/yum.repos.d/remi.repo ]] || \
               [[ -f /etc/yum.repos.d/remi-php*.repo ]] || \
               dnf repolist 2>/dev/null | grep -qi remi; then
                return 0
            fi
            return 1
            ;;
        *)
            return 1
            ;;
    esac
}

setup_php_repository() {
    local pm=$(get_package_manager)

    info_log "Setting up PHP repository for $DISTRO_NAME..."

    case "$pm" in
        apt)
            run_privileged apt-get update -qq
            run_privileged apt-get install -y software-properties-common
            run_privileged add-apt-repository -y ppa:ondrej/php
            run_privileged apt-get update -qq
            success "Ondrej's PHP PPA configured"
            ;;
        dnf)
            # Fedora
            if [[ "$DISTRO_ID" == "fedora" ]]; then
                run_privileged dnf install -y "https://rpms.remirepo.net/fedora/remi-release-${DISTRO_VERSION}.rpm"
            # RHEL/CentOS/Rocky/Alma
            else
                run_privileged dnf install -y epel-release
                run_privileged dnf install -y "https://rpms.remirepo.net/enterprise/remi-release-${DISTRO_VERSION%%.*}.rpm"
            fi
            success "Remi repository configured"
            ;;
        yum)
            run_privileged yum install -y epel-release
            run_privileged yum install -y "https://rpms.remirepo.net/enterprise/remi-release-${DISTRO_VERSION%%.*}.rpm"
            success "Remi repository configured"
            ;;
        *)
            error "Unsupported package manager: $pm"
            echo ""
            echo "Please manually configure a PHP repository for your distribution."
            echo ""
            echo "Supported repositories:"
            echo "  - Ubuntu/Debian: ppa:ondrej/php"
            echo "  - RHEL/CentOS/Fedora: https://rpms.remirepo.net/"
            return 1
            ;;
    esac
}

check_php_available() {
    local version="$1"
    local pm=$(get_package_manager)

    case "$pm" in
        apt)
            apt-cache show "php${version}" &>/dev/null
            ;;
        dnf)
            local v_nodot="${version//./}"
            dnf info "php${v_nodot}" &>/dev/null 2>&1 || \
            dnf info "php${v_nodot}-php-cli" &>/dev/null 2>&1
            ;;
        yum)
            local v_nodot="${version//./}"
            yum info "php${v_nodot}" &>/dev/null 2>&1
            ;;
        *)
            return 1
            ;;
    esac
}

install_php_package() {
    local version="$1"
    shift
    local extensions=("$@")
    local pm=$(get_package_manager)

    case "$pm" in
        apt)
            local packages=("php${version}")
            for ext in "${extensions[@]}"; do
                packages+=("php${version}-${ext}")
            done
            run_privileged apt-get install -y "${packages[@]}"
            ;;
        dnf|yum)
            local v_nodot="${version//./}"
            # Enable Remi module for this PHP version
            if [[ "$pm" == "dnf" ]]; then
                run_privileged dnf module reset php -y 2>/dev/null || true
                run_privileged dnf module enable "php:remi-${version}" -y 2>/dev/null || true
            fi

            local packages=("php${v_nodot}" "php${v_nodot}-php-cli")
            for ext in "${extensions[@]}"; do
                packages+=("php${v_nodot}-php-${ext}")
            done
            run_privileged $pm install -y "${packages[@]}"
            ;;
    esac
}

uninstall_php_package() {
    local version="$1"
    local pm=$(get_package_manager)

    case "$pm" in
        apt)
            run_privileged apt-get remove -y "php${version}*"
            run_privileged apt-get autoremove -y
            ;;
        dnf|yum)
            local v_nodot="${version//./}"
            run_privileged $pm remove -y "php${v_nodot}*"
            ;;
    esac
}

get_installed_versions_platform() {
    local pm=$(get_package_manager)
    local versions=()

    case "$pm" in
        apt)
            # Check for /usr/bin/phpX.Y binaries
            for v in "${SUPPORTED_VERSIONS[@]}"; do
                [[ -x "/usr/bin/php${v}" ]] && versions+=("$v")
            done
            ;;
        dnf|yum)
            # Check for Remi PHP installations
            for v in "${SUPPORTED_VERSIONS[@]}"; do
                local v_nodot="${v//./}"
                if [[ -x "/usr/bin/php${v_nodot}" ]] || \
                   [[ -x "/opt/remi/php${v_nodot}/root/usr/bin/php" ]]; then
                    versions+=("$v")
                fi
            done
            ;;
    esac

    echo "${versions[@]}"
}

# === ui.sh ===

check_gum() {
    if ! command_exists gum; then
        return 1
    fi

    local current_version
    current_version=$(gum --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)

    if [[ -z "$current_version" ]]; then
        return 1
    fi

    version_gte "$current_version" "$GUM_MIN_VERSION"
}

install_gum_github() {
    local arch
    case "$(uname -m)" in
        x86_64)  arch="amd64" ;;
        aarch64) arch="arm64" ;;
        armv7l)  arch="armv7" ;;
        *)       return 1 ;;
    esac

    info_log "Installing gum from GitHub releases..."

    local tmp_dir
    tmp_dir=$(mktemp -d)
    local latest_url="https://api.github.com/repos/${GUM_GITHUB_REPO}/releases/latest"

    # Get latest release info
    local download_url
    download_url=$(curl -fsSL "$latest_url" | grep -oE "https://[^\"]+Linux_${arch}\.(tar\.gz|deb|rpm)" | head -1)

    if [[ -z "$download_url" ]]; then
        rm -rf "$tmp_dir"
        return 1
    fi

    local filename="${download_url##*/}"

    if ! curl -fsSL -o "${tmp_dir}/${filename}" "$download_url"; then
        rm -rf "$tmp_dir"
        return 1
    fi

    # Install based on file type
    case "$filename" in
        *.deb)
            run_privileged dpkg -i "${tmp_dir}/${filename}"
            ;;
        *.rpm)
            run_privileged rpm -i "${tmp_dir}/${filename}"
            ;;
        *.tar.gz)
            tar -xzf "${tmp_dir}/${filename}" -C "$tmp_dir"
            local gum_bin=$(find "$tmp_dir" -name "gum" -type f -executable | head -1)
            if [[ -n "$gum_bin" ]]; then
                run_privileged install -m 755 "$gum_bin" /usr/local/bin/gum
            else
                rm -rf "$tmp_dir"
                return 1
            fi
            ;;
    esac

    rm -rf "$tmp_dir"

    if check_gum; then
        success "gum installed successfully"
        return 0
    fi
    return 1
}

install_gum_package_manager() {
    local pm=$(get_package_manager)

    info_log "Installing gum from package manager..."

    case "$pm" in
        apt)
            # Try to add charm repository
            if ! grep -q "charm.sh" /etc/apt/sources.list.d/* 2>/dev/null; then
                run_privileged mkdir -p /etc/apt/keyrings
                curl -fsSL https://repo.charm.sh/apt/gpg.key | run_privileged gpg --dearmor -o /etc/apt/keyrings/charm.gpg
                echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | \
                    run_privileged tee /etc/apt/sources.list.d/charm.list
                run_privileged apt-get update -qq
            fi
            run_privileged apt-get install -y gum
            ;;
        dnf|yum)
            # Try Charm's rpm repository
            echo '[charm]
name=Charm
baseurl=https://repo.charm.sh/yum/
enabled=1
gpgcheck=1
gpgkey=https://repo.charm.sh/yum/gpg.key' | run_privileged tee /etc/yum.repos.d/charm.repo
            run_privileged $pm install -y gum
            ;;
        *)
            return 1
            ;;
    esac

    check_gum
}

ensure_gum() {
    if check_gum; then
        return 0
    fi

    warn "gum is not installed. Installing..."

    # Try GitHub releases first
    if install_gum_github; then
        return 0
    fi

    warn "GitHub installation failed. Trying package manager..."

    # Try package manager
    if install_gum_package_manager; then
        return 0
    fi

    warn "Could not install gum. Falling back to basic menu."
    return 1
}

UI_MODE="gum"  # gum, fallback

set_ui_mode() {
    if check_gum; then
        UI_MODE="gum"
    else
        UI_MODE="fallback"
    fi
}

print_header() {
    local current_version
    current_version=$(get_current_version)

    local header_text="PHP Version Manager v${PHPVM_VERSION}"
    local status_text

    if [[ -n "$current_version" ]]; then
        status_text="Current: PHP ${current_version}"
    else
        status_text="No PHP installed"
    fi

    if [[ "$UI_MODE" == "gum" ]]; then
        gum style \
            --border rounded \
            --border-foreground 212 \
            --padding "0 2" \
            --margin "1 0" \
            "$header_text" \
            "$status_text"
    else
        echo ""
        echo "+-----------------------------------------------------------------+"
        printf "| %-63s |\n" "$header_text"
        printf "| %-63s |\n" "$status_text"
        echo "+-----------------------------------------------------------------+"
        echo ""
    fi
}

gum_menu() {
    local prompt="$1"
    shift
    local options=("$@")

    if [[ "$UI_MODE" == "gum" ]]; then
        printf '%s\n' "${options[@]}" | gum choose \
            --header "$prompt" \
            --cursor.foreground 212 \
            --header.foreground 99 \
            --selected.foreground 212
    else
        # Fallback: numbered menu
        echo ""
        echo "${CYAN}${prompt}${RESET}"
        echo ""

        local i=1
        for opt in "${options[@]}"; do
            echo "  ${YELLOW}${i})${RESET} $opt"
            ((i++))
        done
        echo ""

        local choice
        read -rp "Enter number (1-${#options[@]}): " choice

        if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice <= ${#options[@]} )); then
            echo "${options[$((choice-1))]}"
        else
            echo ""
        fi
    fi
}

gum_multi_menu() {
    local prompt="$1"
    shift
    local options=("$@")

    if [[ "$UI_MODE" == "gum" ]]; then
        printf '%s\n' "${options[@]}" | gum choose \
            --no-limit \
            --header "$prompt" \
            --cursor.foreground 212 \
            --header.foreground 99 \
            --selected.foreground 212
    else
        # Fallback: comma-separated input
        echo ""
        echo "${CYAN}${prompt}${RESET}"
        echo ""

        local i=1
        for opt in "${options[@]}"; do
            echo "  ${YELLOW}${i})${RESET} $opt"
            ((i++))
        done
        echo ""

        local choices
        read -rp "Enter numbers separated by comma (e.g., 1,3,5): " choices

        IFS=',' read -ra selected <<< "$choices"
        for num in "${selected[@]}"; do
            num=$(echo "$num" | tr -d ' ')
            if [[ "$num" =~ ^[0-9]+$ ]] && (( num >= 1 && num <= ${#options[@]} )); then
                echo "${options[$((num-1))]}"
            fi
        done
    fi
}

gum_confirm() {
    local prompt="$1"
    local default="${2:-yes}"  # yes or no

    if [[ "$UI_MODE" == "gum" ]]; then
        if [[ "$default" == "yes" ]]; then
            gum confirm --default=yes "$prompt"
        else
            gum confirm --default=no "$prompt"
        fi
    else
        local yn
        if [[ "$default" == "yes" ]]; then
            read -rp "${prompt} [Y/n]: " yn
            yn="${yn:-y}"
        else
            read -rp "${prompt} [y/N]: " yn
            yn="${yn:-n}"
        fi

        case "$yn" in
            [Yy]*) return 0 ;;
            *) return 1 ;;
        esac
    fi
}

gum_input() {
    local prompt="$1"
    local default="${2:-}"
    local placeholder="${3:-}"

    if [[ "$UI_MODE" == "gum" ]]; then
        gum input \
            --prompt "$prompt " \
            --value "$default" \
            --placeholder "$placeholder"
    else
        local input
        if [[ -n "$default" ]]; then
            read -rp "${prompt} [$default]: " input
            echo "${input:-$default}"
        else
            read -rp "${prompt}: " input
            echo "$input"
        fi
    fi
}

gum_spin() {
    local title="$1"
    shift

    if [[ "$UI_MODE" == "gum" ]]; then
        gum spin --spinner dot --title "$title" -- "$@"
    else
        echo "${CYAN}${title}...${RESET}"
        "$@"
    fi
}

gum_format() {
    local text="$1"
    local type="${2:-}"  # markdown, code, template

    if [[ "$UI_MODE" == "gum" ]]; then
        case "$type" in
            markdown) echo "$text" | gum format ;;
            code) echo "$text" | gum format -t code ;;
            *) echo "$text" ;;
        esac
    else
        echo "$text"
    fi
}

# === version.sh ===

get_installed_versions() {
    get_installed_versions_platform
}

find_phpversion_file() {
    local dir="$PWD"
    local home_dir="$HOME"

    while [[ "$dir" != "/" && "$dir" != "$home_dir" ]]; do
        if [[ -f "${dir}/.phpversion" ]]; then
            echo "${dir}/.phpversion"
            return 0
        fi
        dir=$(dirname "$dir")
    done

    # Check home directory itself (but not root /)
    if [[ -f "${home_dir}/.phpversion" && "$home_dir" != "/" ]]; then
        echo "${home_dir}/.phpversion"
        return 0
    fi

    return 1
}

find_phpversion_dir() {
    local file
    file=$(find_phpversion_file) || return 1
    dirname "$file"
}

get_current_version() {
    local version=""

    # 1. PHPVERSION_USE env var (session)
    if [[ -n "${PHPVERSION_USE:-}" ]]; then
        version="$PHPVERSION_USE"
    # 2. .phpversion file (local - searches up from $PWD)
    elif local file; file=$(find_phpversion_file) 2>/dev/null; then
        version=$(cat "$file" 2>/dev/null | tr -d '[:space:]')
    # 3. ~/.phpversion/config (user default)
    elif [[ -f "$PHPVM_CONFIG" ]]; then
        version=$(cat "$PHPVM_CONFIG" 2>/dev/null | tr -d '[:space:]')
    # 4. /etc/phpversion (system default)
    elif [[ -f "$SYSTEM_CONFIG" ]]; then
        version=$(cat "$SYSTEM_CONFIG" 2>/dev/null | tr -d '[:space:]')
    # 5. First installed version (fallback)
    else
        local installed
        installed=($(get_installed_versions))
        if [[ ${#installed[@]} -gt 0 ]]; then
            version="${installed[0]}"
        fi
    fi

    # Validate the version is actually installed
    if [[ -n "$version" ]]; then
        local php_bin
        php_bin=$(get_php_binary_path "$version")
        if [[ -x "$php_bin" ]]; then
            echo "$version"
            return 0
        fi
    fi

    # If configured version not installed, fall back to first installed
    local installed
    installed=($(get_installed_versions))
    if [[ ${#installed[@]} -gt 0 ]]; then
        echo "${installed[0]}"
    fi
}

get_version_source() {
    # 1. PHPVERSION_USE env var (session)
    if [[ -n "${PHPVERSION_USE:-}" ]]; then
        echo "session (PHPVERSION_USE=${PHPVERSION_USE})"
        return
    fi

    # 2. .phpversion file (local)
    local file
    if file=$(find_phpversion_file) 2>/dev/null; then
        echo "local (${file})"
        return
    fi

    # 3. ~/.phpversion/config (user default)
    if [[ -f "$PHPVM_CONFIG" ]]; then
        echo "user (~/.phpversion/config)"
        return
    fi

    # 4. /etc/phpversion (system default)
    if [[ -f "$SYSTEM_CONFIG" ]]; then
        echo "system (/etc/phpversion)"
        return
    fi

    # 5. First installed version (fallback)
    echo "fallback (first installed)"
}

get_php_binary() {
    local version="${1:-$(get_current_version)}"

    if [[ -z "$version" ]]; then
        return 1
    fi

    local php_bin
    php_bin=$(get_php_binary_path "$version")

    if [[ -x "$php_bin" ]]; then
        echo "$php_bin"
        return 0
    fi

    return 1
}

get_full_php_version() {
    local version="${1:-$(get_current_version)}"
    local php_bin
    php_bin=$(get_php_binary "$version") || return 1

    "$php_bin" -r 'echo PHP_VERSION;' 2>/dev/null
}

# === install.sh (module) ===

ensure_repository() {
    if ! check_php_repository; then
        warn "PHP repository not configured"

        if gum_confirm "Would you like to set up the PHP repository?"; then
            setup_php_repository || return 1
        else
            error "Cannot install PHP without repository"
            echo ""
            echo "Manual setup instructions:"
            local pm=$(get_package_manager)
            case "$pm" in
                apt)
                    echo "  sudo add-apt-repository ppa:ondrej/php"
                    echo "  sudo apt-get update"
                    ;;
                dnf|yum)
                    echo "  sudo dnf install https://rpms.remirepo.net/enterprise/remi-release-\$(rpm -E %rhel).rpm"
                    echo "  # Or for Fedora:"
                    echo "  sudo dnf install https://rpms.remirepo.net/fedora/remi-release-\$(rpm -E %fedora).rpm"
                    ;;
            esac
            return 1
        fi
    fi
    return 0
}

cmd_install() {
    local requested_version="$1"

    ensure_repository || return 1

    if [[ -n "$requested_version" ]]; then
        # Direct version install: php install 8.4
        validate_version_format "$requested_version" || return 1

        if ! is_supported_version "$requested_version"; then
            error "PHP $requested_version is not in the supported versions list"
            echo "Supported versions: ${SUPPORTED_VERSIONS[*]}"
            return 1
        fi

        # Check if already installed
        local php_bin
        php_bin=$(get_php_binary "$requested_version" 2>/dev/null)

        if [[ -n "$php_bin" && -x "$php_bin" ]]; then
            # Already installed - show options
            local action
            action=$(gum_menu "PHP $requested_version is already installed. What would you like to do?" \
                "Update" \
                "Install extensions" \
                "Uninstall" \
                "Cancel")

            case "$action" in
                "Update")
                    update_php_version "$requested_version"
                    ;;
                "Install extensions")
                    install_extension "$requested_version"
                    ;;
                "Uninstall")
                    uninstall_php_version "$requested_version"
                    ;;
                *)
                    msg "Cancelled"
                    ;;
            esac
        else
            # Not installed - install it
            install_new_php_version "$requested_version"
        fi
    else
        # Interactive install
        local choice
        choice=$(gum_menu "What would you like to install?" \
            "PHP Version" \
            "Extension (for current PHP)")

        case "$choice" in
            "PHP Version")
                install_php_version_interactive
                ;;
            "Extension"*)
                local current
                current=$(get_current_version)
                if [[ -z "$current" ]]; then
                    error "No PHP version installed"
                    echo "Run 'php install' to install a PHP version first"
                    return 1
                fi
                install_extension "$current"
                ;;
            *)
                msg "Cancelled"
                ;;
        esac
    fi
}

install_new_php_version() {
    local version="$1"

    info_log "Checking package availability for PHP $version..."

    if ! check_php_available "$version"; then
        error "PHP $version is not available in the repository"
        echo ""
        echo "This could mean:"
        echo "  - The version is not yet released"
        echo "  - The version is no longer supported"
        echo "  - The repository needs to be updated"
        echo ""
        echo "Try running: sudo apt-get update (or sudo dnf check-update)"
        return 1
    fi

    info_log "Installing PHP $version with default extensions..."

    if gum_spin "Installing PHP $version" install_php_package "$version" "${DEFAULT_EXTENSIONS[@]}"; then
        success "PHP $version installed successfully"

        # Validate installation
        local php_bin
        php_bin=$(get_php_binary "$version")

        if [[ -z "$php_bin" || ! -x "$php_bin" ]]; then
            warn "PHP $version was installed but binary not found at expected location"
            warn "You may need to configure your PATH or check the installation"
        else
            local full_version
            full_version=$("$php_bin" -r 'echo PHP_VERSION;' 2>/dev/null)
            success "Verified: PHP $full_version is working"
        fi

        # Set as default if first installation
        local installed
        installed=($(get_installed_versions))

        if [[ ${#installed[@]} -eq 1 ]]; then
            info_log "Setting PHP $version as default (first installation)"
            mkdir -p "$PHPVM_DIR"
            echo "$version" > "$PHPVM_CONFIG"
        fi

        return 0
    else
        error "Failed to install PHP $version"
        return 1
    fi
}

install_php_version_interactive() {
    local options=()
    local installed
    installed=($(get_installed_versions))

    for v in "${SUPPORTED_VERSIONS[@]}"; do
        local label="PHP $v"
        for inst in "${installed[@]}"; do
            if [[ "$inst" == "$v" ]]; then
                label="[INSTALLED] PHP $v"
                break
            fi
        done
        options+=("$label")
    done

    local choice
    choice=$(gum_menu "Select PHP version to install:" "${options[@]}")

    if [[ -z "$choice" ]]; then
        msg "Cancelled"
        return
    fi

    # Extract version from choice
    local version
    version=$(echo "$choice" | grep -oE '[0-9]+\.[0-9]+')

    if [[ "$choice" == "[INSTALLED]"* ]]; then
        local action
        action=$(gum_menu "PHP $version is already installed. What would you like to do?" \
            "Update" \
            "Install extensions" \
            "Uninstall" \
            "Cancel")

        case "$action" in
            "Update") update_php_version "$version" ;;
            "Install extensions") install_extension "$version" ;;
            "Uninstall") uninstall_php_version "$version" ;;
            *) msg "Cancelled" ;;
        esac
    else
        install_new_php_version "$version"
    fi
}

update_php_version() {
    local version="$1"
    local pm=$(get_package_manager)

    info_log "Updating PHP $version..."

    case "$pm" in
        apt)
            gum_spin "Updating PHP $version" run_privileged apt-get upgrade -y "php${version}*"
            ;;
        dnf|yum)
            local v_nodot="${version//./}"
            gum_spin "Updating PHP $version" run_privileged $pm update -y "php${v_nodot}*"
            ;;
    esac

    success "PHP $version updated"
}

uninstall_php_version() {
    local version="$1"

    if ! gum_confirm "Are you sure you want to uninstall PHP $version?" "no"; then
        msg "Cancelled"
        return
    fi

    info_log "Uninstalling PHP $version..."

    gum_spin "Removing PHP $version" uninstall_php_package "$version"

    success "PHP $version uninstalled"

    # Clean up config if this was the default
    if [[ -f "$PHPVM_CONFIG" ]]; then
        local configured
        configured=$(cat "$PHPVM_CONFIG" 2>/dev/null | tr -d '[:space:]')
        if [[ "$configured" == "$version" ]]; then
            rm -f "$PHPVM_CONFIG"
            info_log "Removed user default configuration"
        fi
    fi
}

install_extension() {
    local version="$1"
    local pm=$(get_package_manager)

    info_log "Fetching available extensions for PHP $version..."

    local available=()
    local installed_ext=()

    case "$pm" in
        apt)
            # Get available packages
            while IFS= read -r line; do
                local ext_name
                ext_name=$(echo "$line" | sed "s/php${version}-//" | cut -d' ' -f1)
                available+=("$ext_name")
            done < <(apt-cache search "^php${version}-" 2>/dev/null | sort)

            # Get installed packages
            while IFS= read -r line; do
                local ext_name
                ext_name=$(echo "$line" | sed "s/php${version}-//")
                installed_ext+=("$ext_name")
            done < <(dpkg -l "php${version}-*" 2>/dev/null | grep "^ii" | awk '{print $2}' | sed "s/:.*//")
            ;;
        dnf|yum)
            local v_nodot="${version//./}"
            while IFS= read -r line; do
                local ext_name
                ext_name=$(echo "$line" | sed "s/php${v_nodot}-php-//" | sed "s/php${v_nodot}-//" | cut -d'.' -f1)
                available+=("$ext_name")
            done < <($pm list available "php${v_nodot}*" 2>/dev/null | grep -v "^Last" | awk '{print $1}' | sort -u)

            while IFS= read -r line; do
                local ext_name
                ext_name=$(echo "$line" | sed "s/php${v_nodot}-php-//" | sed "s/php${v_nodot}-//" | cut -d'.' -f1)
                installed_ext+=("$ext_name")
            done < <($pm list installed "php${v_nodot}*" 2>/dev/null | grep -v "^Installed" | awk '{print $1}')
            ;;
    esac

    if [[ ${#available[@]} -eq 0 ]]; then
        error "No extensions found for PHP $version"
        return 1
    fi

    # Build display options
    local options=()
    for ext in "${available[@]}"; do
        local label="$ext"
        for inst in "${installed_ext[@]}"; do
            if [[ "$inst" == "$ext" ]]; then
                label="[INSTALLED] $ext"
                break
            fi
        done
        options+=("$label")
    done

    local choice
    choice=$(gum_menu "Select extension for PHP $version:" "${options[@]}")

    if [[ -z "$choice" ]]; then
        msg "Cancelled"
        return
    fi

    local ext_name
    ext_name=$(echo "$choice" | sed 's/\[INSTALLED\] //')

    if [[ "$choice" == "[INSTALLED]"* ]]; then
        local action
        action=$(gum_menu "Extension $ext_name is installed. What would you like to do?" \
            "Update" \
            "Uninstall" \
            "Cancel")

        case "$action" in
            "Update")
                case "$pm" in
                    apt) gum_spin "Updating $ext_name" run_privileged apt-get upgrade -y "php${version}-${ext_name}" ;;
                    dnf|yum) gum_spin "Updating $ext_name" run_privileged $pm update -y "php${version//./}-php-${ext_name}" ;;
                esac
                success "Extension $ext_name updated"
                ;;
            "Uninstall")
                case "$pm" in
                    apt) gum_spin "Removing $ext_name" run_privileged apt-get remove -y "php${version}-${ext_name}" ;;
                    dnf|yum) gum_spin "Removing $ext_name" run_privileged $pm remove -y "php${version//./}-php-${ext_name}" ;;
                esac
                success "Extension $ext_name removed"
                ;;
            *)
                msg "Cancelled"
                ;;
        esac
    else
        info_log "Installing extension $ext_name for PHP $version..."
        case "$pm" in
            apt) gum_spin "Installing $ext_name" run_privileged apt-get install -y "php${version}-${ext_name}" ;;
            dnf|yum) gum_spin "Installing $ext_name" run_privileged $pm install -y "php${version//./}-php-${ext_name}" ;;
        esac
        success "Extension $ext_name installed"
    fi
}

check_no_php_installed() {
    local installed
    installed=($(get_installed_versions))

    if [[ ${#installed[@]} -eq 0 ]]; then
        warn "No PHP versions installed"
        echo ""

        if gum_confirm "Would you like to install PHP now?"; then
            cmd_install
            return $?
        else
            echo "Run 'php install' when ready to install PHP"
            exit 1
        fi
    fi
}

# === use.sh ===

PHPVM_SESSION_FILE="${PHPVM_SESSION_FILE:-}"

cmd_use() {
    local requested_version="$1"

    # Check if any PHP installed
    local installed
    installed=($(get_installed_versions))

    if [[ ${#installed[@]} -eq 0 ]]; then
        warn "No PHP versions installed"
        if gum_confirm "Would you like to install PHP now?"; then
            cmd_install
        fi
        return
    fi

    local version

    if [[ -n "$requested_version" ]]; then
        # Version specified
        validate_version_format "$requested_version" || return 1

        # Check if installed
        local found=false
        for v in "${installed[@]}"; do
            [[ "$v" == "$requested_version" ]] && found=true && break
        done

        if [[ "$found" == "false" ]]; then
            warn "PHP $requested_version is not installed"
            if gum_confirm "Would you like to install PHP $requested_version?"; then
                install_new_php_version "$requested_version" || return 1
            else
                return 1
            fi
        fi

        version="$requested_version"
    else
        # Interactive selection
        local options=()
        local current
        current=$(get_current_version)

        for v in "${installed[@]}"; do
            local label="PHP $v"
            [[ "$v" == "$current" ]] && label="PHP $v <- current"
            options+=("$label")
        done

        local choice
        choice=$(gum_menu "Select PHP version:" "${options[@]}")

        if [[ -z "$choice" ]]; then
            msg "Cancelled"
            return
        fi

        version=$(echo "$choice" | grep -oE '[0-9]+\.[0-9]+')
    fi

    # Select scope
    local scope
    scope=$(gum_menu "Set PHP $version for:" \
        "This session only" \
        "This directory (local .phpversion)" \
        "This user (global default)" \
        "System-wide (all users)")

    case "$scope" in
        "This session only")
            set_session_version "$version"
            ;;
        "This directory"*)
            set_local_version "$version"
            ;;
        "This user"*)
            set_user_version "$version"
            ;;
        "System-wide"*)
            set_system_version "$version"
            ;;
        *)
            msg "Cancelled"
            ;;
    esac
}

set_session_version() {
    local version="$1"

    # If running interactively with session file, write to it
    if [[ -n "$PHPVM_SESSION_FILE" ]]; then
        echo "$version" > "$PHPVM_SESSION_FILE"
        success "PHP $version set for this session"
    else
        # Output marker for shell wrapper to detect
        echo "PHPVERSION_USE=$version"
        success "PHP $version set for this session"
        echo ""
        echo "${DIM}Note: Run 'source ~/.bashrc' or start a new terminal for changes to take effect${RESET}"
    fi
}

set_local_version() {
    local version="$1"
    local target_dir="$PWD"

    # Check if .phpversion exists in parent directories
    local existing_file
    existing_file=$(find_phpversion_file 2>/dev/null)

    if [[ -n "$existing_file" && "$(dirname "$existing_file")" != "$PWD" ]]; then
        local choice
        choice=$(gum_menu "Found existing .phpversion in parent directory. Create in:" \
            "Current directory ($PWD)" \
            "Existing location ($(dirname "$existing_file"))" \
            "Cancel")

        case "$choice" in
            "Current directory"*)
                target_dir="$PWD"
                ;;
            "Existing location"*)
                target_dir=$(dirname "$existing_file")
                ;;
            *)
                msg "Cancelled"
                return
                ;;
        esac
    fi

    # Don't allow in root or home directly (unless explicit)
    if [[ "$target_dir" == "/" ]]; then
        error "Cannot create .phpversion in root directory"
        return 1
    fi

    echo "$version" > "${target_dir}/.phpversion"
    success "PHP $version set for ${target_dir}"
    info_log "Created ${target_dir}/.phpversion"
}

set_user_version() {
    local version="$1"

    mkdir -p "$PHPVM_DIR"
    echo "$version" > "$PHPVM_CONFIG"
    success "PHP $version set as user default"
    info_log "Updated ~/.phpversion/config"
}

set_system_version() {
    local version="$1"

    check_sudo

    run_privileged tee "$SYSTEM_CONFIG" > /dev/null <<< "$version"
    success "PHP $version set as system-wide default"
    info_log "Updated /etc/phpversion"
}

# === list.sh ===

cmd_list() {
    local subcommand="$1"

    if [[ "$subcommand" == "extensions" ]]; then
        list_extensions
    else
        list_versions
    fi
}

list_versions() {
    local installed
    installed=($(get_installed_versions))

    if [[ ${#installed[@]} -eq 0 ]]; then
        warn "No PHP versions installed"
        echo "Run 'php install' to install a PHP version"
        return
    fi

    local current
    current=$(get_current_version)

    echo ""
    echo "${BOLD}Installed PHP Versions:${RESET}"
    echo ""

    for v in "${installed[@]}"; do
        local php_bin
        php_bin=$(get_php_binary "$v")
        local full_version
        full_version=$("$php_bin" -r 'echo PHP_VERSION;' 2>/dev/null)

        if [[ "$v" == "$current" ]]; then
            echo "  ${GREEN}->${RESET} ${BOLD}PHP ${v}${RESET} (${full_version}) ${GREEN}<- active${RESET}"
        else
            echo "    PHP ${v} (${full_version})"
        fi
    done

    echo ""
}

list_extensions() {
    local version
    version=$(get_current_version)

    if [[ -z "$version" ]]; then
        error "No PHP version active"
        return 1
    fi

    local php_bin
    php_bin=$(get_php_binary "$version")

    echo ""
    echo "${BOLD}Extensions for PHP ${version}:${RESET}"
    echo ""

    echo "${CYAN}Loaded extensions (php -m):${RESET}"
    "$php_bin" -m 2>/dev/null | grep -v "^\[" | sort | while read -r ext; do
        echo "  * $ext"
    done

    echo ""
    echo "${CYAN}Installed packages:${RESET}"

    local pm=$(get_package_manager)
    case "$pm" in
        apt)
            dpkg -l "php${version}-*" 2>/dev/null | grep "^ii" | awk '{print "  * " $2}'
            ;;
        dnf|yum)
            local v_nodot="${version//./}"
            $pm list installed "php${v_nodot}*" 2>/dev/null | grep -v "^Installed" | awk '{print "  * " $1}'
            ;;
    esac

    echo ""
}

# === info.sh ===

cmd_info() {
    local version
    version=$(get_current_version)

    if [[ -z "$version" ]]; then
        error "No PHP version active"
        return 1
    fi

    local php_bin
    php_bin=$(get_php_binary "$version")
    local source
    source=$(get_version_source)

    print_header

    # PHPVM Info
    echo "${BOLD}PHPVM:${RESET}"
    echo "  Version: ${PHPVM_VERSION}"
    echo "  GitHub:  https://github.com/${PHPVM_REPO}"
    echo ""

    # PHP Version Info
    echo "${BOLD}PHP Information:${RESET}"
    echo ""

    echo "${CYAN}Version:${RESET}"
    "$php_bin" -v 2>/dev/null | head -1
    echo ""

    echo "${CYAN}Binary:${RESET} $php_bin"
    echo "${CYAN}Source:${RESET} $source"
    echo ""

    # php.ini locations
    echo "${CYAN}Configuration Files:${RESET}"
    local ini_cli
    ini_cli=$("$php_bin" --ini 2>/dev/null | grep "Loaded Configuration File" | cut -d':' -f2 | tr -d ' ')
    echo "  CLI php.ini: ${ini_cli:-Not found}"

    local fpm_ini="/etc/php/${version}/fpm/php.ini"
    if [[ -f "$fpm_ini" ]]; then
        echo "  FPM php.ini: $fpm_ini"
    fi
    echo ""

    # Key settings
    echo "${CYAN}Key Settings:${RESET}"
    echo "  memory_limit:        $("$php_bin" -r 'echo ini_get("memory_limit");' 2>/dev/null)"
    echo "  max_execution_time:  $("$php_bin" -r 'echo ini_get("max_execution_time");' 2>/dev/null)s"
    echo "  upload_max_filesize: $("$php_bin" -r 'echo ini_get("upload_max_filesize");' 2>/dev/null)"
    echo "  post_max_size:       $("$php_bin" -r 'echo ini_get("post_max_size");' 2>/dev/null)"
    echo ""

    # Composer info
    local composer_dir="$PHPVM_DIR/$version/composer"
    echo "${CYAN}Composer:${RESET}"
    if [[ -f "$composer_dir/composer.phar" ]]; then
        local composer_version
        composer_version=$("$php_bin" "$composer_dir/composer.phar" --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
        echo "  Version: $composer_version"
        echo "  Global packages: $composer_dir/vendor/"
    else
        echo "  Not installed for this PHP version"
        echo "  Run 'composer' to install"
    fi
    echo ""

    # Version Resolution Order
    echo "${CYAN}Version Resolution Order:${RESET}"
    echo ""

    local active_found=false

    # 1. Session
    if [[ -n "${PHPVERSION_USE:-}" ]]; then
        echo "  ${GREEN}[x]${RESET} 1. Session (PHPVERSION_USE=${PHPVERSION_USE})"
        active_found=true
    else
        echo "  ${DIM}[ ] 1. Session (PHPVERSION_USE not set)${RESET}"
    fi

    # 2. Local
    local local_file
    local_file=$(find_phpversion_file 2>/dev/null)
    if [[ -n "$local_file" && "$active_found" == "false" ]]; then
        local local_version
        local_version=$(cat "$local_file" 2>/dev/null | tr -d '[:space:]')
        echo "  ${GREEN}[x]${RESET} 2. Local (${local_file} = ${local_version})"
        active_found=true
    elif [[ -n "$local_file" ]]; then
        local local_version
        local_version=$(cat "$local_file" 2>/dev/null | tr -d '[:space:]')
        echo "  ${DIM}[ ] 2. Local (${local_file} = ${local_version})${RESET}"
    else
        echo "  ${DIM}[ ] 2. Local (no .phpversion found)${RESET}"
    fi

    # 3. User
    if [[ -f "$PHPVM_CONFIG" ]]; then
        local user_version
        user_version=$(cat "$PHPVM_CONFIG" 2>/dev/null | tr -d '[:space:]')
        if [[ "$active_found" == "false" ]]; then
            echo "  ${GREEN}[x]${RESET} 3. User (~/.phpversion/config = ${user_version})"
            active_found=true
        else
            echo "  ${DIM}[ ] 3. User (~/.phpversion/config = ${user_version})${RESET}"
        fi
    else
        echo "  ${DIM}[ ] 3. User (~/.phpversion/config not set)${RESET}"
    fi

    # 4. System
    if [[ -f "$SYSTEM_CONFIG" ]]; then
        local system_version
        system_version=$(cat "$SYSTEM_CONFIG" 2>/dev/null | tr -d '[:space:]')
        if [[ "$active_found" == "false" ]]; then
            echo "  ${GREEN}[x]${RESET} 4. System (/etc/phpversion = ${system_version})"
            active_found=true
        else
            echo "  ${DIM}[ ] 4. System (/etc/phpversion = ${system_version})${RESET}"
        fi
    else
        echo "  ${DIM}[ ] 4. System (/etc/phpversion not set)${RESET}"
    fi

    # 5. Fallback
    if [[ "$active_found" == "false" ]]; then
        echo "  ${GREEN}[x]${RESET} 5. Fallback (first installed)"
    else
        echo "  ${DIM}[ ] 5. Fallback (first installed)${RESET}"
    fi

    echo ""
}

# === config_edit.sh ===

view_config_file() {
    local file="$1"
    local title="$2"

    if [[ "$UI_MODE" == "gum" ]]; then
        gum pager --show-line-numbers < "$file"
    else
        # Fallback to less or cat
        if command_exists less; then
            less -N "$file"
        else
            cat -n "$file"
        fi
    fi
}

cmd_config() {
    local version
    version=$(get_current_version)

    if [[ -z "$version" ]]; then
        error "No PHP version active"
        return 1
    fi

    local choice
    choice=$(gum_menu "Select configuration file:" \
        "CLI php.ini" \
        "FPM php.ini" \
        "FPM Pool (www.conf)")

    local file
    case "$choice" in
        "CLI php.ini")
            file="/etc/php/${version}/cli/php.ini"
            ;;
        "FPM php.ini")
            file="/etc/php/${version}/fpm/php.ini"
            ;;
        "FPM Pool"*)
            file="/etc/php/${version}/fpm/pool.d/www.conf"
            ;;
        *)
            msg "Cancelled"
            return
            ;;
    esac

    if [[ ! -f "$file" ]]; then
        error "Configuration file not found: $file"
        return 1
    fi

    # Ask what to do with the file
    local action
    action=$(gum_menu "What would you like to do with $file?" \
        "View" \
        "Edit")

    case "$action" in
        "View")
            view_config_file "$file" "$choice"
            ;;
        "Edit")
            edit_config_file "$file" "$choice" "$version"
            ;;
        *)
            msg "Cancelled"
            ;;
    esac
}

edit_config_file() {
    local file="$1"
    local choice="$2"
    local version="$3"

    # Select editor
    local editor
    if command_exists micro; then
        editor="micro"
    elif [[ -n "$EDITOR" ]]; then
        editor="$EDITOR"
    elif command_exists nano; then
        editor="nano"
    elif command_exists vim; then
        editor="vim"
    else
        editor="vi"
    fi

    info_log "Opening $file with $editor..."
    run_privileged "$editor" "$file"

    # Offer to restart FPM if editing FPM config
    if [[ "$choice" == "FPM"* ]]; then
        local service="php${version}-fpm"
        if systemctl is-active "$service" &>/dev/null; then
            if gum_confirm "Restart PHP-FPM to apply changes?"; then
                run_privileged systemctl restart "$service"
                success "PHP-FPM restarted"
            fi
        fi
    fi
}

# === fpm.sh ===

cmd_fpm() {
    local installed
    installed=($(get_installed_versions))

    if [[ ${#installed[@]} -eq 0 ]]; then
        error "No PHP versions installed"
        return 1
    fi

    # Find installed FPM services
    local fpm_services=()
    for v in "${installed[@]}"; do
        local service="php${v}-fpm"
        if systemctl list-unit-files "$service.service" &>/dev/null; then
            fpm_services+=("$v")
        fi
    done

    if [[ ${#fpm_services[@]} -eq 0 ]]; then
        warn "No PHP-FPM services installed"
        if gum_confirm "Would you like to install PHP-FPM?"; then
            local version
            version=$(get_current_version)
            local pm=$(get_package_manager)
            case "$pm" in
                apt) run_privileged apt-get install -y "php${version}-fpm" ;;
                dnf|yum) run_privileged $pm install -y "php${version//./}-php-fpm" ;;
            esac
            success "PHP-FPM installed"
        fi
        return
    fi

    # Main FPM menu
    local action
    action=$(gum_menu "PHP-FPM Management:" \
        "Service Control (start/stop/restart)" \
        "Enable/Disable Service" \
        "Edit Configuration" \
        "Create New Pool" \
        "Manage Pools" \
        "View Status")

    case "$action" in
        "Service Control"*)
            fpm_service_control "${fpm_services[@]}"
            ;;
        "Enable/Disable"*)
            fpm_enable_disable "${fpm_services[@]}"
            ;;
        "Edit Configuration")
            cmd_config
            ;;
        "Create New Pool")
            fpm_create_pool
            ;;
        "Manage Pools")
            fpm_manage_pools
            ;;
        "View Status")
            fpm_view_status "${fpm_services[@]}"
            ;;
        *)
            msg "Cancelled"
            ;;
    esac
}

fpm_service_control() {
    local services=("$@")
    local current
    current=$(get_current_version)

    # Build service options with status
    local options=()
    for v in "${services[@]}"; do
        local service="php${v}-fpm"
        local status
        if systemctl is-active "$service" &>/dev/null; then
            status="${GREEN}running${RESET}"
        else
            status="${RED}stopped${RESET}"
        fi
        local label="PHP $v FPM ($status)"
        [[ "$v" == "$current" ]] && label="$label <- current"
        options+=("$label")
    done

    local choice
    choice=$(gum_menu "Select FPM service:" "${options[@]}")

    if [[ -z "$choice" ]]; then
        return
    fi

    local version
    version=$(echo "$choice" | grep -oE '[0-9]+\.[0-9]+')
    local service="php${version}-fpm"

    local action
    action=$(gum_menu "Action for $service:" \
        "Start" \
        "Stop" \
        "Restart" \
        "Reload" \
        "Status")

    case "$action" in
        "Start")   run_privileged systemctl start "$service" && success "Started $service" ;;
        "Stop")    run_privileged systemctl stop "$service" && success "Stopped $service" ;;
        "Restart") run_privileged systemctl restart "$service" && success "Restarted $service" ;;
        "Reload")  run_privileged systemctl reload "$service" && success "Reloaded $service" ;;
        "Status")  systemctl status "$service" ;;
    esac
}

fpm_enable_disable() {
    local services=("$@")

    local options=()
    for v in "${services[@]}"; do
        local service="php${v}-fpm"
        local status
        if systemctl is-enabled "$service" &>/dev/null; then
            status="${GREEN}enabled${RESET}"
        else
            status="${YELLOW}disabled${RESET}"
        fi
        options+=("PHP $v FPM ($status)")
    done

    local choice
    choice=$(gum_menu "Select FPM service:" "${options[@]}")

    if [[ -z "$choice" ]]; then
        return
    fi

    local version
    version=$(echo "$choice" | grep -oE '[0-9]+\.[0-9]+')
    local service="php${version}-fpm"

    if systemctl is-enabled "$service" &>/dev/null; then
        if gum_confirm "Disable $service?"; then
            run_privileged systemctl disable "$service"
            success "$service disabled"
        fi
    else
        if gum_confirm "Enable $service?"; then
            run_privileged systemctl enable "$service"
            success "$service enabled"
        fi
    fi
}

fpm_create_pool() {
    local version
    version=$(get_current_version)

    echo ""
    echo "${BOLD}Create New PHP-FPM Pool${RESET}"
    echo ""

    local name
    name=$(gum_input "Pool name:" "" "myapp")

    if [[ -z "$name" ]]; then
        msg "Cancelled"
        return
    fi

    local user
    user=$(gum_input "User:" "$(whoami)")

    local group
    group=$(gum_input "Group:" "$(id -gn)")

    local socket
    socket=$(gum_input "Socket path:" "/run/php/${name}.sock")

    local pool_file="/etc/php/${version}/fpm/pool.d/${name}.conf"

    if [[ -f "$pool_file" ]]; then
        error "Pool configuration already exists: $pool_file"
        return 1
    fi

    run_privileged tee "$pool_file" > /dev/null <<EOF
[$name]
user = $user
group = $group
listen = $socket
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3

; Logging
catch_workers_output = yes
php_admin_flag[log_errors] = on
EOF

    success "Pool created: $pool_file"

    if gum_confirm "Restart PHP-FPM to activate?"; then
        run_privileged systemctl restart "php${version}-fpm"
        success "PHP-FPM restarted"
    fi
}

fpm_manage_pools() {
    local version
    version=$(get_current_version)
    local pool_dir="/etc/php/${version}/fpm/pool.d"

    if [[ ! -d "$pool_dir" ]]; then
        error "Pool directory not found: $pool_dir"
        return 1
    fi

    local pools=()
    while IFS= read -r -d '' file; do
        local name
        name=$(basename "$file")
        if [[ "$name" == *.disabled ]]; then
            pools+=("${name%.conf.disabled} (disabled)")
        else
            pools+=("${name%.conf} (enabled)")
        fi
    done < <(find "$pool_dir" -name "*.conf*" -print0 2>/dev/null)

    if [[ ${#pools[@]} -eq 0 ]]; then
        warn "No pools found"
        return
    fi

    local choice
    choice=$(gum_menu "Select pool:" "${pools[@]}")

    if [[ -z "$choice" ]]; then
        return
    fi

    local pool_name
    pool_name=$(echo "$choice" | cut -d' ' -f1)

    local action
    action=$(gum_menu "Action for $pool_name:" \
        "Edit" \
        "Enable/Disable" \
        "Delete")

    case "$action" in
        "Edit")
            local file="$pool_dir/${pool_name}.conf"
            [[ ! -f "$file" ]] && file="$pool_dir/${pool_name}.conf.disabled"
            run_privileged "${EDITOR:-nano}" "$file"
            ;;
        "Enable/Disable")
            if [[ -f "$pool_dir/${pool_name}.conf" ]]; then
                run_privileged mv "$pool_dir/${pool_name}.conf" "$pool_dir/${pool_name}.conf.disabled"
                success "Pool $pool_name disabled"
            else
                run_privileged mv "$pool_dir/${pool_name}.conf.disabled" "$pool_dir/${pool_name}.conf"
                success "Pool $pool_name enabled"
            fi
            ;;
        "Delete")
            if gum_confirm "Delete pool $pool_name?" "no"; then
                run_privileged rm -f "$pool_dir/${pool_name}.conf" "$pool_dir/${pool_name}.conf.disabled"
                success "Pool $pool_name deleted"
            fi
            ;;
    esac
}

fpm_view_status() {
    local services=("$@")

    echo ""
    echo "${BOLD}PHP-FPM Services Status:${RESET}"
    echo ""

    for v in "${services[@]}"; do
        local service="php${v}-fpm"
        local active_status enabled_status

        if systemctl is-active "$service" &>/dev/null; then
            active_status="${GREEN}running${RESET}"
        else
            active_status="${RED}stopped${RESET}"
        fi

        if systemctl is-enabled "$service" &>/dev/null; then
            enabled_status="${GREEN}enabled${RESET}"
        else
            enabled_status="${YELLOW}disabled${RESET}"
        fi

        printf "  PHP %s FPM: %s / %s\n" "$v" "$active_status" "$enabled_status"
    done

    echo ""
}

# === self_update.sh ===

cmd_self_update() {
    info_log "Checking for updates..."

    local current_version="$PHPVM_VERSION"
    local latest_info

    # Fetch latest release info from GitHub
    latest_info=$(curl -fsSL "$PHPVM_GITHUB_API" 2>/dev/null)

    if [[ -z "$latest_info" ]]; then
        error "Failed to check for updates"
        echo "Could not connect to GitHub API"
        return 1
    fi

    local latest_version
    latest_version=$(echo "$latest_info" | grep -oE '"tag_name":\s*"v?[0-9]+\.[0-9]+\.[0-9]+"' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)

    if [[ -z "$latest_version" ]]; then
        error "Could not determine latest version"
        return 1
    fi

    echo ""
    echo "${BOLD}Current version:${RESET} $current_version"
    echo "${BOLD}Latest version:${RESET}  $latest_version"
    echo ""

    if version_gte "$current_version" "$latest_version"; then
        success "You are already running the latest version!"
        return 0
    fi

    # Show changelog if available
    local changelog
    changelog=$(echo "$latest_info" | grep -oE '"body":\s*"[^"]*"' | sed 's/"body":\s*"//' | sed 's/"$//' | head -20)

    if [[ -n "$changelog" ]]; then
        echo "${BOLD}Changelog:${RESET}"
        echo "$changelog" | sed 's/\\n/\n/g' | head -10
        echo ""
    fi

    if ! gum_confirm "Update to v${latest_version}?"; then
        msg "Update cancelled"
        return
    fi

    info_log "Downloading update..."

    local tmp_dir
    tmp_dir=$(mktemp -d)

    # Download the installer script
    local installer_url="${PHPVM_RAW_URL}/src/install.sh"

    if ! curl -fsSL -o "${tmp_dir}/install.sh" "$installer_url"; then
        error "Failed to download installer"
        rm -rf "$tmp_dir"
        return 1
    fi

    info_log "Running installer..."

    # Determine current installation mode
    local install_mode="user"
    if [[ -f "/usr/local/bin/php" ]]; then
        install_mode="system"
    fi

    # Run installer with appropriate mode
    if [[ "$install_mode" == "system" ]]; then
        run_privileged bash "${tmp_dir}/install.sh" --upgrade
    else
        bash "${tmp_dir}/install.sh" --upgrade --user
    fi

    rm -rf "$tmp_dir"

    success "Updated to v${latest_version}!"
    echo ""
    echo "Please restart your shell or run: source ~/.bashrc"
}

# === help.sh ===

show_help() {
    print_header

    cat <<EOF
${BOLD}Usage:${RESET} php [command] [options]

${BOLD}Version Management:${RESET}
  use [version]       Switch PHP version (interactive if no version)
  install [version]   Install PHP version or extension
  list                List installed PHP versions
  list extensions     List extensions for current PHP

${BOLD}Information:${RESET}
  info                Show PHPVM, PHP info, and version resolution

${BOLD}Configuration:${RESET}
  config              Edit PHP configuration files
  fpm                 Manage PHP-FPM services and pools

${BOLD}Maintenance:${RESET}
  self-update         Update PHPVM to latest version
  help                Show this help message

${BOLD}Pass-through:${RESET}
  php [args]          Any other arguments pass to PHP binary
  php -v              Show PHP version (pass-through)
  php --version       Show PHP version (pass-through)
  php script.php      Execute PHP script

${BOLD}Composer:${RESET}
  composer [args]     Run Composer with current PHP version

${BOLD}Version Resolution Order:${RESET}
  1. PHPVERSION_USE environment variable (session)
  2. .phpversion file (local, searches up from current directory)
  3. ~/.phpversion/config (user default)
  4. /etc/phpversion (system default)
  5. First installed version (fallback)

${BOLD}Examples:${RESET}
  php use 8.4              # Switch to PHP 8.4 (select scope)
  php install 8.3          # Install PHP 8.3
  php install              # Interactive install menu
  php list                 # Show installed versions
  php info                 # Show detailed info
  echo "8.4" > .phpversion # Set project PHP version
  composer require foo     # Run composer with current PHP

${BOLD}More Info:${RESET}
  GitHub: https://github.com/${PHPVM_REPO}
EOF
}

# === Main ===
main() {
    setup_colors
    detect_distro
    set_ui_mode

    # No arguments - show help
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        # Version management
        use)
            init_phpvm
            cmd_use "$@"
            ;;
        install)
            init_phpvm
            cmd_install "$@"
            ;;
        list)
            init_phpvm
            cmd_list "$@"
            ;;

        # Information
        info)
            init_phpvm
            cmd_info
            ;;

        # Configuration
        config)
            init_phpvm
            cmd_config
            ;;
        fpm)
            init_phpvm
            cmd_fpm
            ;;

        # Maintenance
        self-update|selfupdate|update)
            cmd_self_update
            ;;

        # Help
        help|--help|-h)
            show_help
            ;;

        # Pass-through to PHP
        -v|--version)
            # These go directly to PHP binary
            local php_binary
            php_binary=$(get_php_binary 2>/dev/null)
            if [[ -n "$php_binary" && -x "$php_binary" ]]; then
                exec "$php_binary" "$command" "$@"
            else
                error "No PHP version installed"
                echo "Run 'php install' to install PHP"
                exit 1
            fi
            ;;

        *)
            # Any other command passes through to PHP binary
            local php_binary
            php_binary=$(get_php_binary 2>/dev/null)
            if [[ -z "$php_binary" || ! -x "$php_binary" ]]; then
                error "No PHP version installed"
                echo "Run 'php install' to install PHP"
                exit 1
            fi
            exec "$php_binary" "$command" "$@"
            ;;
    esac
}

main "$@"
